---
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import { Image } from "astro:assets";

import MusicianLayout from "@/layouts/MusicianLayout.astro";
import Paragraph from "@/components/UI/Paragraph.astro";
import MaxWidthContainer from "@/components/UI/MaxWidthContainer.astro";
import Card from "@/components/UI/Card.astro";
import Heading from "@/components/Heading/Heading";
import { Head } from "../performances";

const articles = await getCollection("singing");

// Create a typed map: Record<string, CollectionEntry<"articles">[]>
const grouped: Record<string, CollectionEntry<"singing">[]> = {};

for (const article of articles) {
    const category = article.data.category;

    // Skip index files (those that don't have a slash in their slug)
    if (!article.slug.includes("/")) {
        continue;
    }

    if (!grouped[category]) {
        grouped[category] = [];
    }

    grouped[category].push(article);
}
---

<MusicianLayout
    title="Singing"
    description="A collection of singing-related articles and resources."
>
    <MaxWidthContainer>
        <Heading level={1}>Singing</Heading>
        {
            Object.entries(grouped).map(([category, items]) => (
                <section>
                    <Heading level={2}>
                        <a href={`/singing/${category}`}>{category}</a>
                    </Heading>

                    <ul>
                        {items.map((article) => (
                            <li>
                                <Card>
                                    {article.data.cover && (
                                        <Image
                                            class="cover"
                                            slot="header"
                                            src={article.data.cover}
                                            alt={article.data.title}
                                            layout="full-width"
                                        />
                                    )}
                                    <Fragment slot="content" class="content">
                                        <a href={`/singing/${article.slug}`}>
                                            {article.data.title}
                                            <Paragraph size="sm">
                                                {article.data.description}
                                            </Paragraph>
                                        </a>
                                    </Fragment>
                                </Card>
                            </li>
                        ))}
                    </ul>
                </section>
            ))
        }
    </MaxWidthContainer>

    <style lang="scss">
        @use "@/styles/abstracts" as *;
        section {
            background: get-color("lightShades", 400);
            border-radius: $border-radius;
            @include padding-box("sm");
            @include shadow(1);
            & + section {
                margin-block: $space-lg;
            }

            a {
                padding-block: $space-sm;
                padding-inline: $space-md;
                display: inline-block;
                width: 100%;
                color: inherit;

                &:visited {
                    color: inherit;
                }
            }
        }
        ul {
            display: grid;
            grid-template-columns: repeat(
                auto-fill,
                minmax(px-to-rem(300), 1fr)
            );
            gap: $space-md;
            list-style: none;
        }
    </style>
</MusicianLayout>
